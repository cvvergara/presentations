<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8">

<title>pgRouting: WORKSHOP QGIS-LATAM 2020</title>

<meta name="description" content="Uso Básico de QGIS con pgRouting">
<meta name="author" content="Vicky Vergara, Economist">

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

<link rel="stylesheet" href="../css/reveal.min.css">
<link rel="stylesheet" href="../css/theme/default.css" id="theme">

<!-- For syntax highlighting -->
<link rel="stylesheet" href="../lib/css/zenburn.css">

<!-- Printing and PDF exports -->
<script>
var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );
</script>


<link rel="stylesheet" href="../css/custom.css">

<!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
</head>

<body>

<div class="reveal">

    <div class="slides">


        <!-- How to flip edges -->
        <section data-background="./images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h2>El proyecto pgRouting </h2>
            <img style="border:0;background:none;padding-top:80px;padding-bottom:40px;height:250px" src="../img/pgrouting.png" />
            <h3>Taller: Uso básico de pgRouting con QGIS</h3>
            <br></br>
            <img class="logo" src="../img/georepublic.png" />
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h2 style="padding-top:40px;padding-bottom:30px;">Material</h2>
            <ul>
                <li>Base de datos con los datos ejemplo de la documentación <i style="color:green"><strong>datos_ejemplo</strong></i></li>
                <li>QGIS</li>
            </ul>
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>Veamos el mapa</h3>
            <ol>
                <li>Abrir QGIS</li>
                <li>Conectarse a la base de datos <i style="color:green"><strong>datos_ejemplo</strong></i> database</li>
                <li>Agregar <i style="color:green"><strong>edge_table</strong></i> y cambiar nombre a <i style="color:red"><strong>Edges</strong></i></li>
                <li>Agregar <i style="color:green"><strong>edge_table_vertices_pgr</strong></i> y cambiar nombre a <i style="color:red"><strong>Vertices</strong></i></li>
                <li>Etiquetar la capa <i style="color:red"><strong>Vertices</strong></i> con el id</li>
            </ol>
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <img class="stretch" src="./qgis_latam/flipgeometries1.jpg" />
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>Hacer una ruta de 2 a 3</h3>
            <pre><code data-trim class="sql" style="line-height:50px; font-size: 140%;">
SELECT * FROM pgr_dijkstra('
  SELECT id,
    source,target,
    cost, reverse_cost
  FROM edge_table',
  2, 3, true); </code></pre>
        </section>


        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>Resultados de la consulta</h3>
            <pre><code data-trim class="sql" style="line-height:28px; font-size: 140%;">
seq | path_seq | node | edge | cost | agg_cost 
----+----------+------+------+------+----------
  1 |        1 |    2 |    4 |    1 |        0
  2 |        2 |    5 |    8 |    1 |        1
  3 |        3 |    6 |    9 |    1 |        2
  4 |        4 |    9 |   16 |    1 |        3
  5 |        5 |    4 |    3 |    1 |        4
  6 |        6 |    3 |   -1 |    0 |        5
(6 rows) </code></pre>
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            El interés es en la <i style="color:green"><strong>geometría</strong></i> de la ruta ...
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>Haciendo una vista</h3>
            <ol>
                <li>Hacer la operación <i style="color:BLUE"><strong>JOIN</strong></i> con la tabla <i style="color:green"><strong>edge_table</strong></i></li>
                <li>Extraer la geometría</li>
                <li>La columna "seq" nos da un identificador único que QGIS necesita</li>
            </ol>
            <pre><code data-trim class="sql" style="line-height:28px; font-size: 140%;">
CREATE VIEW route_from2To3_1 AS
WITH
dijkstra AS (SELECT * FROM pgr_dijkstra('
    SELECT id,
        source, target,
        cost, reverse_cost
        FROM edge_table',
    2, 3, true))
SELECT seq, the_geom AS route_geom FROM dijkstra
   JOIN edge_table ON(edge = id);
            </code></pre>
        </section>


        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>Ver los resultados en Qgis</h3>
            <ol>
                <li>Añadir la capa <i style="color:red"><strong>route_from2To3_1 </strong></i></li>
                <li>Esconder la capa <i style="color:red"><strong>Edges</strong></i></li>
            </ol>
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <img class="stretch" src="./qgis_latam/flipgeometries2.jpg" />
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            Hasta ahorita todo va como debe
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>Agregar flechas en QGIS</h3>
            <ol>
                <li>Agregar flechas a la capa <i style="color:red"><strong>route_from2To3_1 </strong></i></li>
            </ol>
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <img class="stretch" src="./qgis_latam/flipgeometries3.jpg" />
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <p>Después de agregar flechas a la capa <i style="color:red"><strong>route_from2To3_1 </strong></i></p>
            <p>Algunas flechas van en la dirección equivocada</p>
            <ul>
               <li>De <i style="color:red"><strong>4</strong></i> a <i style="color:red"><strong>9</strong></i> debiera ser de <i style="color:green"><strong>9</strong></i> a <i style="color:green"><strong>4</strong></i></li>
	       <li>De <i style="color:red"><strong>3</strong></i> a <i style="color:red"><strong>4</strong></i> debiera ser de <i style="color:green"><strong>4</strong></i> a <i style="color:green"><strong>3</strong></i></li>
            </ul>
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            Está la necesidad de invertir las geometrías temporalmente!!
        </section>


        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
	    La orientación de las geometrías depende del nodo donde el segmento de la ruta comienza
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
		Usar la columna <i style="color:green"><b>node</b></i> de los resultados para ajustar la geometría
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3> Pseudocódigo </h3>
            <pre><code data-trim class="sql" style="line-height:28px; font-size: 140%;">
SI (el nodo es source en edge_table)
    La orientación de la geometría está bien
ELSE
    Invertir la orientación de la geometría
            </code></pre>

            <h3> Código en SQL </h3>
            <pre><code data-trim class="sql" style="line-height:28px; font-size: 140%;">
CASE
WHEN dijkstra.node = edge_table.source
  THEN edge_table.the_geom
  ELSE ST_Reverse(edge_table.the_geom)
END AS route_geom
            </code></pre>
        </section>


        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <p>Hacer una nueva vista</p>
            <pre><code data-trim class="sql" style="line-height:28px; font-size: 140%;">
CREATE VIEW route_from2To3_2 AS
WITH
dijkstra AS (SELECT * FROM pgr_dijkstra('
    SELECT id, source, target, cost, reverse_cost
        FROM edge_table',
    2, 3, true))
SELECT seq,
    CASE
    WHEN dijkstra.node = edge_table.source
      THEN edge_table.the_geom
      ELSE ST_Reverse(edge_table.the_geom)
    END AS route_geom
FROM dijkstra
   JOIN edge_table ON(edge = id);
            </code></pre>
        </section>


        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>Ver el resultado en QGIS</h3>
            <ol>
                <li>Añadir la capa <i style="color:red"><strong>route_from2To3_2</strong></i></li>
                <li>Añadir flechas a la capa <i style="color:red"><strong>route_from2To3_2</strong></i> layer</li>
                <li>Esconder la capa <i style="color:red"><strong>route_from2To3_1</strong></i></li>
            </ol>
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <img class="stretch" src="./qgis_latam/flipgeometries4.jpg" />
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>Cuando se necesita información adicional</h3>
            <p>Por ejemplo: el id de la geometría usado como nombre...</p>
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>Hacemos otra vista </h3>
            <pre><code data-trim class="sql" style="line-height:28px; font-size: 120%;">
CREATE VIEW route_from2To3_3 AS
WITH
dijkstra AS (SELECT * FROM pgr_dijkstra('
    SELECT id, source, target, cost, reverse_cost
        FROM edge_table',
    2, 3, true))
SELECT seq, id AS name, -- informacion adicional
    CASE
    WHEN dijkstra.node = edge_table.source
      THEN edge_table.the_geom
      ELSE ST_Reverse(edge_table.the_geom)
    END AS route_geom
FROM dijkstra
   JOIN edge_table ON(edge = id);
            </code></pre>
        </section>

        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <h3>See the result in Qgis</h3>
            <ul>
            <ol>
                <li>Añadir la nueva capa <i style="color:red"><strong>route_from2To3_3</strong></i></li>
                <li>Añadir flechas a la capa <i style="color:red"><strong>route_from2To3_3</strong></i></li>
                <li>Agregar la etiqueta <i style="color:green">name</i> </li>
                <li>Esconder la capa <i style="color:red"><strong>route_from2To3_2</strong></i></li>
            </ol>
        </section>

        <!-- TODO -->
        <section data-background="images/mexicoMap.png" style="background-color:#000000;background:rgba(0, 0, 0, 0.85);">
            <img class="stretch" src="./qgis_latam/flipgeometries5.jpg" />
        </section>

    </div>

</div>

<script src="../lib/js/head.min.js"></script>
<script src="../js/reveal.min.js"></script>

<script>

// Full list of configuration options available at:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
controls: true,
progress: true,
history: true,
center: true,
slideNumber: true,

transition: 'convex', // none/fade/slide/convex/concave/zoom
math: {
// mathjax: 'http://cdn.mathjax.org/mathjax/latest/MathJax.js',
config: 'TeX-AMS_HTML-full'
},

// Optional reveal.js plugins
dependencies: [
{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
{ src: '../plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
{ src: '../plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
{ src: '../plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
{ src: '../plugin/zoom-js/zoom.js', async: true },
{ src: '../plugin/notes/notes.js', async: true },
{ src: '../plugin/math/math.js', async: true }
]
});

</script>

</body>
</html>
